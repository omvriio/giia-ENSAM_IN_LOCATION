<!doctype html>
<html>
    {% if title %}
    <title>IN_LOCATION- {{title}}</title>
    {% else %}
    <title>IN_LOCATION </title>
    {% endif %}
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='main.css')}}">
    <!-- Bootstrap CSS -->
    <!-- Bootstrap CSS -->

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <link rel="icon" href="../static/icon/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Silkscreen&display=swap">

</head>
  <body>
      <header>
      <nav class="navbar bg-steelv">
        <a href="/" class="nav__link " >
          <div class="d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" height ="30" width="auto" viewBox="0 0 71.11 60.26">
              <g id="Layer_2" data-name="Layer 2">
                <g id="Layer_1-2" data-name="Layer 1">
                  <path class="cls-2" d="M69.92,43c-5.13-8.16-10.1-16.42-15.28-24.55-2.27-3.55-4-7.5-7.36-10.93-2,4-4,7.8-6,11.59l1.91,6.82a6.54,6.54,0,0,1-.65,5.83l-.06.09a89,89,0,0,0,8.95-.06c4.76-.39,8,1.19,9.84,5.61.56,1.32,2.38,2.46,1.55,3.93s-2.72.76-4.15.77q-25.68.3-51.36.52a23.92,23.92,0,0,0-4,.16A4,4,0,0,0,0,46.6c0,2.23,2.28,1.18,3.56,1.29,2.31.2,4.82-.28,5.38,3,.18,1.11.21,2.52,1.76,2.61,1.75.09,2.1-1.36,2.42-2.66C13.57,49,14.5,47.94,16.56,48s2.47,1.29,2.75,2.88c.41,2.35,1.65,3.14,3.87,2,1.87-1.6,3.62-2.59,5.53-.08-3.79-2-3.85-1.72-4.7,2.87-1.39,2-4.53,1.52-5.53,4.64,10.71-5.2,21.62-5,32.7-1.56-1.6-2.15-4.37-2.45-5-5-1.08-4.13-2.24-1-3.38-.09a4,4,0,0,1-2.62-.19h.05a1.82,1.82,0,0,0,1.8-.79c.81-1.88.23-4.8,2.79-5.39,3-.69,2.55,2.27,3.35,3.91s2.3,1.62,2.91.06c2.05-5.28,3.88-6.49,6.09-.12.49,1.39,2.26,1.8,2.5.38.88-5.39,4.75-4.68,8.35-4.53C72.07,47.18,71.5,45.49,69.92,43Z"/>
                  <path class="cls-2" d="M21.21,6.87q-1.34,2.42-2.63,4.77l1.62-.4Z"/>
                  <path class="cls-2" d="M4.21,40.31A3.24,3.24,0,0,0,8,40.18a11.21,11.21,0,0,0,2.81-4c1.33-3.51,3.82-4.76,7.35-4.48l6.62.16L23,31.32l-1.65-.46L9.75,27.66C7.88,31,6.05,34.37,4.22,37.71,3.79,38.5,3,39.6,4.21,40.31Z"/>
                  <path class="cls-2" d="M9.84,22.5l26.47,7.32a1.78,1.78,0,0,0,2.18-2.34L31.17,1.33a1.85,1.85,0,0,0-3.58.15l-3,12.77a2.11,2.11,0,0,1-1.4,1.4L9.84,18.92C8,19.23,8,22,9.84,22.5Z"/>
                </g>
              </g>
            </svg>
            <h2 style="font-family: 'Silkscreen';color:azure;"> IN_LOCATION</h2>
          </div>
        </a>
        <a id="camera--switch" class="nav__link" >
          <svg xmlns="http://www.w3.org/2000/svg" width="auto" height="30" viewBox="0 0 72 60.93">
            <g id="Layer_2" data-name="Layer 2">
              <g id="Layer_1-2" data-name="Layer 1">
                <path class="cls-2" d="M46.67,4,52,12h8.2a7.79,7.79,0,0,1,5.52,2.3,7.58,7.58,0,0,1,2.3,5.6V49a7.86,7.86,0,0,1-7.83,7.9H11.86a7.82,7.82,0,0,1-5.55-2.3A7.51,7.51,0,0,1,4,49.11V19.88a7.59,7.59,0,0,1,2.31-5.6A7.77,7.77,0,0,1,11.83,12H20l5.3-8h21.4M36.25,18.83h-.13a13.77,13.77,0,0,0-7.85,2.46A14.91,14.91,0,0,0,23,27.5v.05a7,7,0,0,0-.89-.65,2.17,2.17,0,0,0-1-.24H21.1a2.4,2.4,0,0,0-1.71.72,2.28,2.28,0,0,0-.72,1.7,2.91,2.91,0,0,0,.16.88,1.39,1.39,0,0,0,.4.72l2.89,4h.08l.33.32.08.08c.08,0,.16.08.31.16h.17c0,.09.08.09.16.09a.25.25,0,0,1,.17.08h.76a.4.4,0,0,0,.28-.08c.08-.09.16-.09.32-.17v.08h.09a.58.58,0,0,0,.32-.16c.08,0,.16-.08.32-.16h-.08l4-2.89a2.24,2.24,0,0,0,.65-.81,2.15,2.15,0,0,0,.24-1.7,2.12,2.12,0,0,0-.33-.56,1.75,1.75,0,0,0-.8-.72,2.22,2.22,0,0,0-1-.25h0a8.65,8.65,0,0,1,3.56-3.06,9.62,9.62,0,0,1,4.51-1.15h0a2.48,2.48,0,0,0,2.46-2.5A2.34,2.34,0,0,0,38,19.55a2.4,2.4,0,0,0-1.71-.72h-.07M47.8,31.38v-.09h-.08a.62.62,0,0,0-.33.17c-.08,0-.15.08-.32.16h.09l-4,2.89a2.22,2.22,0,0,0-.64.81,1.58,1.58,0,0,0-.32,1,1.42,1.42,0,0,0,.08.64,2.63,2.63,0,0,0,1.13,1.29,2.29,2.29,0,0,0,1,.25h0a8.81,8.81,0,0,1-3.56,3.07,9.57,9.57,0,0,1-4.51,1.13h-.06a2.48,2.48,0,0,0-2.45,2.51A2.31,2.31,0,0,0,34.56,47a2.36,2.36,0,0,0,1.7.72h.3a13.83,13.83,0,0,0,7.75-2.38,15.24,15.24,0,0,0,5.25-6.22V39a5.72,5.72,0,0,0,.88.65,2.31,2.31,0,0,0,1,.24h.07a2.5,2.5,0,0,0,2.43-2.43,3.42,3.42,0,0,0-.17-.89,1.48,1.48,0,0,0-.4-.72l-2.89-3.95h-.08l-.32-.33L50,31.44c-.08,0-.16-.08-.32-.16h-.17c0-.08-.08-.08-.16-.08a.28.28,0,0,1-.15-.08h-.73a.52.52,0,0,0-.32.09c-.08.08-.16.08-.32.17M48.82,0H23.12L21.93,1.79,17.83,8h-6a11.84,11.84,0,0,0-8.34,3.46A11.63,11.63,0,0,0,0,19.92V49.09a11.58,11.58,0,0,0,3.5,8.39,11.75,11.75,0,0,0,8.36,3.45H60.17A11.87,11.87,0,0,0,72,49V19.92a11.56,11.56,0,0,0-3.49-8.48A11.82,11.82,0,0,0,60.17,8H54.11L50,1.79,48.82,0Z"/>
              </g>
            </g>
          </svg>
        </a>
        <a id="tot" style="color:azure; font-family: 'Silkscreen';"></a>
      </nav> 
      <nav class="nav1video bg-steelv">
        <a href="/" class="nav__link">
          <div class="d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="auto" height="30" viewBox="0 0 63.12 66">
              <g id="Layer_2" data-name="Layer 2">
                <g id="Layer_1-2" data-name="Layer 1">
                  <path class="cls-1 " style="padding: 3px;" d="M10.27,64H52.84a8.29,8.29,0,0,0,8.28-8.28V24.5A11.09,11.09,0,0,0,55.77,15L36.29,3.31a9.18,9.18,0,0,0-9.46,0L7.35,15A11.1,11.1,0,0,0,2,24.5V55.72A8.28,8.28,0,0,0,10.27,64Zm10.2-16.66a9,9,0,0,1,9-9H33.7a9,9,0,0,1,8.95,9v9.39H20.47Z"/>
                </g>
              </g>
            </svg>
            <span class="transition-span d-none d-md-inline ml-5" style="font-family: 'Silkscreen';"> index</span>
          </div>
        </a>
        <a id="triggerButton" class="nav__link">
          <div class="d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="auto" height="40" viewBox="0 0 76.65 76.85">
              <g id="Layer_2" data-name="Layer 2">
                <g id="Layer_1-2" data-name="Layer 1">
                  <path class="cls-1 path-hovered-1"  d="M74.65,36.23a.83.83,0,0,0-.82-.83H65.49a27.33,27.33,0,0,0-23.42-24,.82.82,0,0,1-.71-.8l-.11-7.72A.82.82,0,0,0,40.43,2L36.11,2a.82.82,0,0,0-.83.81l-.22,8.45h0A27.44,27.44,0,0,0,11.16,35.4H2.83a.83.83,0,0,0-.83.83v4.42a.83.83,0,0,0,.83.83h7.6a.82.82,0,0,1,.82.71A27.18,27.18,0,0,0,34.52,65.68a.83.83,0,0,1,.71.81l.05,7.37a.83.83,0,0,0,.8.82l4.43.17a.83.83,0,0,0,.86-.83v-7.7a.82.82,0,0,1,.71-.81,27.33,27.33,0,0,0,23.41-24h8.34a.83.83,0,0,0,.82-.83ZM46.32,32,41.57,49a1.21,1.21,0,0,1-2.34,0l-2.08-8.59a1.21,1.21,0,0,0-.91-.9l-8.18-1.86A1.21,1.21,0,0,1,28,35.21L44.82,30.5A1.22,1.22,0,0,1,46.32,32Z"/>
                </g>
              </g>
            </svg>
            <span class="transition-span d-none d-md-inline ml-5" style="font-family: 'Silkscreen';"> VIDEO</span>
          </div>
        </a>
        <a href="/map" class="nav__link">
          <div class="d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" height=40 width=auto viewBox="0 0 55.65 56.38">
              <g id="Layer_2" data-name="Layer 2">
                <g id="Layer_1-2" data-name="Layer 1">
                  <path class="cls-1" d="M17.69,21.72c-1.09-3.76-2.78-9.61.36-14.78.52-.85,3.73-5.9,9.29-6,5.25-.08,8.53,4.36,9.15,5.25,3.62,5.16,2,11.48,1.1,15a29.93,29.93,0,0,1-10,15.39A31.13,31.13,0,0,1,17.69,21.72ZM27.34,8.9a4.89,4.89,0,1,0,4.88,4.88A4.88,4.88,0,0,0,27.34,8.9Z"/>
                  <path class="cls-1" d="M18.3,47,11.22,18.05,1,23.18l.12,31.63L18.3,47l19.05,8.42,17.22-8.3.12-31.87-11,4.51Q40.52,37.6,37.35,55.42"/>
                </g>
              </g>
            </svg>
            <span class="transition-span d-none d-md-inline ml-5" style="font-family: 'Silkscreen';"> map</span>
          </div>
        </a>
      </nav>
      
    </header>
      
      
            
    
    <main id="camera">
      <!-- Camera sensor -->
      <canvas id="camera--sensor"></canvas>
      <!-- Camera view -->
      <video id="camera--view" autoplay playsinline></video>
      <img id="received-image" style="display: none;" >
    </main>
    
    <script>
        document.addEventListener("DOMContentLoaded", async function() {
        const videoElement = document.getElementById('camera--view');
        const canvas = document.getElementById('camera--sensor');
        const imgElement = document.getElementById('received-image');
        const tot = document.getElementById("tot");
        const switchButton = document.getElementById('camera--switch');

        let currentDeviceIndex = 0; // Index of the current camera device
        const constraints ={
            video: {
              width: {
                min: 1280,
                ideal: 1920,
                max: 2560,
              },
              height: {
                min: 720,
                ideal: 1080,
                max: 1440
              },
            }
          };
          let firstdeviceId=null;

        // Function to switch to the next available camera device
        const switchCamera = async () => {
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();

            // Filter out only video devices (cameras)
            const videoDevices = devices.filter(device => (device.kind === 'videoinput' && (device.deviceId != firstdeviceId)));

            if (videoDevices.length <= 1) {
              alert('Only one camera device found.');
              return;
            }

            currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;

            // Get the new selected camera device
            const selectedDevice = videoDevices[currentDeviceIndex];

            // Stop the current camera stream (if any)
            if (videoElement.srcObject) {
              const tracks = videoElement.srcObject.getTracks();
              tracks.forEach(track => track.stop());
            }

            // Get the new camera stream
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { deviceId: selectedDevice.deviceId },
            });
            // Set the new stream to the video element
            videoElement.srcObject = stream;
          } catch (error) {
            console.error('Error switching camera:', error);
            tot.innerText='swii';
          }
        };

        // Event listener for the switch button
        switchButton.addEventListener('click', switchCamera);

        // Initialize the camera stream on page load
        navigator.mediaDevices.getUserMedia(constraints)
          .then(stream => {
            videoElement.srcObject = stream;
            firstdeviceId = stream.getVideoTracks[0].getSettings().deviceId;

          })
          .catch(error => {
            console.error('Error accessing camera:', error);
            tot.innerText= 'No Camera Access';
          });

        let captureDuration = 5000;
        let ctx = canvas.getContext('2d');
        let isCapturing = false;

        let captureButton = document.getElementById('triggerButton');
        captureButton.addEventListener('click', async function () {
            isCapturing = true;
            await captureFrame();
            tot.innerText=errorCount;

            setTimeout(async function () {
                isCapturing = false;
                await localisationresult();
            }, captureDuration);

        });
        let errorCount=0;
        async function captureFrame() {
            if (isCapturing) {
                canvas.width=videoElement.videoWidth;
                canvas.height=videoElement.videoHeight;
                tot.innerText=canvas.height+"x"+canvas.width;
                ctx.drawImage(videoElement, 0, 0, videoElement.videoWidth, videoElement.videoHeight);
                var imageData = canvas.toDataURL('image/jpeg',0.5);
                imageData= await sendFramesToServer(imageData);
                // Convert base64 to blob
                imageData= atob(imageData);
                var byteNumbers = new Array(imageData.length);
                for (var i = 0; i < imageData.length; i++) {
                    byteNumbers[i] = imageData.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                var blob = new Blob([byteArray], { type: 'image/jpeg' });

                // Convert blob to data URL
                var reader = new FileReader();
                reader.onloadend = function () {
                    var convertedImageData = reader.result;

                    // Use the converted data URL as the src attribute
                    imgElement.setAttribute('src', convertedImageData);
                    imgElement.onerror = function () {
                      errorCount++; // Increment the error count
                      // You can also update the UI or take appropriate actions
                    };
                };
                imgElement.style="display:inline;";
                videoElement.style.display="none";
                // Capture the next frame after a short delay
                setTimeout(captureFrame, 10);
            }
        }

        async function sendFramesToServer(img) {
            try {
                // Send the captured frames to the server
                let response = await fetch('{{ url_for("process_frame") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ frameData: img }),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                let data = await response.json();
                return data.frameData;
            } catch (error) {
                console.error("Error sending frames to server:", error);
                tot.innerText = "error";
            }
        }
        async function localisationresult(){
          try {
                // Send the captured frames to the server
                let respons = await fetch('{{ url_for("localisation") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                });

                let dat = await respons.json();
                localStorage.setItem('datMsg', dat.msg);
                window.location.href = "{{url_for('map')}}";
            } catch (error) {
                console.error("Error sending frames to server:", error);
                tot.innerText = "error";
            }

        }


    });
        // video.style.transform = (currentDeviceIndex === 0) ? "scaleX(-1)" : "none";
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
    <form ></form>
  </body>
</html>